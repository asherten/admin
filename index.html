<script>
/* ------------------- CONFIG ------------------- */
const endpoint    = 'https://trash-proxy.stormdraindna.workers.dev/';
const MAX_RETRIES = 3;            // per record
/* ---------------------------------------------- */

const fileInput = document.getElementById('fileInput');
const recordBtn = document.getElementById('recordBtn');

/* -------- Small offline queue using localStorage -------- */
function loadQueue()      { return JSON.parse(localStorage.queue || '[]'); }
function saveQueue(q)     { localStorage.queue = JSON.stringify(q); }
function enqueue(job)     { const q = loadQueue(); q.push(job); saveQueue(q); }
function dequeue()        { const q = loadQueue(); const j = q.shift(); saveQueue(q); return j; }
async function flushQueue(){
  while (loadQueue().length) {
    const job = dequeue();
    const ok  = await trySend(job);
    if (!ok) { enqueue(job); break; }   // stop if still offline
  }
}

/* ------------- Utility: shrink & compress ------------- */
async function shrinkAndCompress(dataUrl) {
  return new Promise(resolve => {
    const img = new Image();
    img.src = dataUrl;
    img.onload = () => {
      let {width,w:W, height:h:H} = img;
      const max = 1024;
      if (width > max || height > max) {
        const s = max / Math.max(width,height);
        width *= s; height *= s;
      }
      const c = document.createElement('canvas');
      c.width = width; c.height = height;
      c.getContext('2d').drawImage(img, 0, 0, width, height);
      resolve(c.toDataURL('image/jpeg', 0.7));
    };
    img.onerror = () => resolve(dataUrl);
  });
}

/* ------------- Send with retry logic ------------------ */
async function trySend(payload){
  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++){
    try {
      const r  = await fetch(endpoint, {
        method: 'POST',
        headers:{'Content-Type':'application/json'},
        body:   JSON.stringify(payload)
      });
      const t  = await r.text();
      const js = JSON.parse(t || '{}');
      if (js.status === 'ok') return true;
      throw new Error(js.error || 'Server error');
    } catch (e){
      if (attempt === MAX_RETRIES) return false;
      await new Promise(res => setTimeout(res, 600 * attempt));
    }
  }
}

/* ------------- Event handlers ------------------------- */
recordBtn.onclick = () => fileInput.click();

fileInput.addEventListener('change', async e => {
  try {
    const file = e.target.files[0];
    if (!file) return;

    // 1. Read + compress image
    const reader = new FileReader();
    reader.readAsDataURL(file);
    await new Promise(r => reader.onloadend = r);
    const photo = await shrinkAndCompress(reader.result);

    // 2. Geolocation
    const pos = await new Promise((res, rej) =>
                 navigator.geolocation.getCurrentPosition(res, rej, {timeout:10000}));
    const {latitude:lat, longitude:lng} = pos.coords;

    // 3. Build job + enqueue
    const job = {photo, lat, lng, ts: Date.now()};
    enqueue(job);
    await flushQueue();

    alert('✅ Saved locally – will sync immediately when online.');
    fileInput.value = '';       // reset picker
  } catch (err){
    alert('❌ '+err.message);
  }
});

/* Flush anything left from previous offline sessions */
window.addEventListener('load', flushQueue);
window.addEventListener('online', flushQueue);
</script>
